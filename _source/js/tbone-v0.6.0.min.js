(function(){function n(){}function H(a){return null!==a&&"object"===typeof a&&!E(a)}function E(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)}function A(a){return!(!a||"function"!==typeof a.query)}function S(a){return"string"===typeof a||"number"===typeof a&&!isNaN(a)||E(a)||"boolean"===typeof a?a+"":""}function sa(a){var b=[];e.each(e.values(a._callbacks||{}),function(a){for(a=a.next;;)if(a.context)b.push(a.context),a=a.next;else break});e.each(e.flatten(e.values(a._events||{})),function(a){a.context&&
b.push(a.context)});if(A(a)&&"function"===typeof a){a=[a._events];for(var c,d,h;c=a.pop();)for(h in c)if(""===h){d=c[""];for(var f in d)b.push(d[f])}else a.push(c[h])}return e.uniq(b)}function fa(a){var b=[a];for(a=[a];b.length;)for(var c=b.pop(),c=sa(c),d=0;d<c.length;d++){var h=c[d];h.G&&(h=h.context);if(h){if(h.H)return!0;h.n&&-1===a.indexOf(h)&&(b.push(h),a.push(h))}}return!1}function s(a,b,c,d,h,f,e){b||(b=t?t.b-1:0);!d&&t&&(d=t.N+"+");a=new ga(a,c,b,d,h,f);!e&&t&&t.h.push(a);a.execute();return a}
function ga(a,b,c,d,h,f){e.extend(this,{fn:a,context:b,b:c,Name:d,t:h,I:f,h:[]})}function y(a){return a.tboneid=a.tboneid||ha++}function ta(){T&&(U.sort(function(a,b){return a.b-b.b}),T=!1);return U.pop()}function ia(){return!B&&!C}function ja(){V||(V=setTimeout(function(){g.query("__isReady__",ia());g.query("__ajaxReady__",!B);g.query("__numAjaxInFlight__",B);V=null},20))}function ka(a){var b=y(a);W[b]||(W[b]=!0,U.push(a),T=!0,C||(ja(),C=e.defer(X)))}function Y(a){return M&&(a?la.scrollTop(a):la.scrollTop())}
function X(){Z=!1;var a=Y();C=null;for(var b,c=5E3;--c&&(b=ta());)delete W[y(b)],b.execute();c||(C=e.defer(X));ja();a&&!Z&&a!==Y()&&Y(a)}function J(a,b,c,d,h,f,e){if(16<f)return!0;b=b||{};if(A(d)||A(c))e=!0;var l=e,k;for(k in b)""===k?d!==c&&(H(d)&&H(c)?h=!0:l=E(d)&&E(c)?d.getTime()!==c.getTime()||l:!0):l=J(a,b[k],c&&c[k],d&&d[k],!1,f+1,e)||l;if(h&&!l)if(H(d)&&H(c)){e={};var g=[d,c];for(h=0;2>h&&!l;h++){var F=g[h];if("[object Array]"===ma.call(F))for(d.length!==c.length&&(l=!0),k=0;k<F.length&&!l;k++)e[k]||
(e[k]=!0,J(a,b[k],c[k],d[k],!0,f+1,!1)&&(l=!0));else for(k in F)if(!e[k]&&(e[k]=!0,J(a,b[k],c[k],d[k],!0,f+1,!1))){l=!0;break}}}else E(d)&&E(c)?l=d.getTime()!==c.getTime():d!==c&&(l=!0);if(l){a=b[""]||{};for(var p in a)a[p].trigger.call(a[p])}return l}function N(a,b,c){var d=1===a,h=2===a,f=3===a,I=4===a,l=5===a,k=6===a,g=7===a,F=9===a,p=f||I||l||k,O=8===a,q=3===arguments.length,D=p||g||O||q||F;"number"!==typeof a&&(c=b,b=a,a=0,2===arguments.length&&(q=D=!0));b=(b||"").replace("__self__","");var v=
b.split("."),w=[],x;for(x=0;x<v.length;x++)v[x]&&w.push(v[x]);v=w[w.length-1]||"attributes";x=this;for(var m=d&&!b?this:this.attributes,n=[],r,z,t={},s=D&&this._events.change;;){if(null==m&&!D){n=n.concat(w);break}else if(m!==this&&A(m)){z=w.length||(D?!O&&!A(c):!d);break}else if(D&&!H(m)&&(w.length||p)){if(O)return;m=(w.length?aa.exec(w[0]):p)?[]:{};this.query(n.join("."),m)}r=w.shift();if(null==r)break;n.push(r);x=m;m=m[r];s&&(e.extend(t,s[""]||{}),s=s[r])}!D&&u&&(d=y(this),u[d]||(u[d]={obj:this,
props:{}}),u[d].props[n.join(".")]=m);if(z)return q?m.query(a,w.join("."),c):m.query(a,w.join("."));if(D){f?m.push(c):I?m.unshift(c):l?m.shift(c):k?m.pop(c):O?delete x[v]:g?c=x[v]=!m:F?c=x[v]=(m||0)+c:x[v]=c;if(e.isEmpty(t))J(this,s,m,c,!1,0,!1);else if(J(this,s,m,c,!0,0,!1))for(var B in t)t[B].trigger.call(t[B]);return c}!h&&this.e&&""===b&&("[object Array]"===ma.call(m)?m=e.map(m,function(a){return a.query()}):m&&(m=e.reduce(e.keys(m),function(a,b){A(m[b])&&(a[b]=m[b].query());return a},{})));return m}
function K(a,b){return S(null==b?this.query(a):this.query(a,b))}function ba(a){return a.replace(/^change:/,"change.").split(ua)}function va(a,b){var c=wa.read;e.defaults(b||(b={}),{emulateHTTP:g.emulateHTTP,emulateJSON:g.emulateJSON});var d={type:c,dataType:"json"};b.url||(d.url=e.result(a,"url")||urlError());b.emulateJSON&&(d.contentType="application/x-www-form-urlencoded",d.data=d.data?{model:d.data}:{});if(b.emulateHTTP&&("PUT"===c||"DELETE"===c||"PATCH"===c)){d.type="POST";b.emulateJSON&&(d.data.O=
c);var h=b.F;b.F=function(a){a.setRequestHeader("X-HTTP-Method-Override",c);if(h)return h.apply(this,arguments)}}"GET"===d.type||b.emulateJSON||(d.processData=!1);"PATCH"!==d.type||!window.ActiveXObject||window.external&&window.external.P||(d.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});b.xhr=a.ajax(e.extend(d,b))}function xa(a,b){return a.replace(ya,function(a,d,h,f){return ca[f]||d||aa.test(f)?a:null!=b[f]?["(",f," && view.isQueryable(",f,") ? ",f,'.query("',h.slice(f.length+1),
'") : ',h,")"].join(""):['view.query(2, "',h,'")'].join("")})}function za(a){function b(){d=e.invert(e.flatten(c))}var c=[[]],d={};b();a=a.replace(Aa,function(a,f,e){function l(){var a=xa(k.join(""),d);k=[];return a}var k=[];(a="@"===f)&&(f="");e=e.replace(Ba,function(a,d,h){return d.replace(Ca,function(a,d,h,f,e,I){if(I)return k.push(I),"";f?c.push([]):d?d.replace(Da,function(a){c[c.length-1].push(a)}):e&&c.pop();b();return l()+a})+l()+(h||"")})+l();return"<%"+(a?"= view.getHashId("+e+") ":f?f+"view.denullText("+
e+")":e)+"%>"});return e.template(a,null,{variable:"view"})}function Ea(a,b){var c=L[a];if(null==c&&(c=$('script[name="'+a+'"]').html(),!c))return"";"string"===typeof c&&(c=L[a]=za(c));return c(b)}function na(a,b,c){var d={};e.each(c||[],function(a){(d[a.u]=d[a.u]||[]).push(a)});return e.map(a,function(a){var c=$(a),e=a.outerHTML;if(d[e]&&d[e].length)return a=d[e].shift(),c.replaceWith(a.el),a;var l={};(c.attr("tbone")||"").replace(Fa,function(a,b,c){l[b]=c});var k=l.inline;if(k){var n=c.html().replace(/&lt;/g,
"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");L[k]=n}var r=k||l.tmpl,k=l.root,p=l.view||r,n=P[p]||da;c.addClass(p);for(var q=n.v;q&&q.Name;)c.addClass(q.Name),q=q.v;c={Name:p,u:e,el:a,C:r,d:b,w:Q[k]||g,A:Q[k]?"":k};delete Q[k];return n.make(c)})}var r,e;"undefined"!==typeof exports?(e=require("underscore")._,r=exports):(r=window,e=r._);var z={},G={},L={},P={},ma=Object.prototype.toString,Ga=0,t,u;e.extend(ga.prototype,{G:!0,trigger:function(){ka(this)},execute:function(){var a=this;if(!a.k){a.D();
a.r();var b=u;this.o=u={};var c=t;t=a;try{a.fn.call(a.context)}catch(d){g.push("__errors__."+a.Name,(d&&d.stack||d)+"")}e.each(u,function(b){var c=b.obj;b=b.props;if(b[""])c.on("change",a.trigger,a);else for(var d in b)c.on("change:"+d,a.trigger,a)});a.t&&a.t.call(a.I,this);u=b;t=c}},D:function(){var a=this.o||{},b;for(b in a){var c=a[b],d=c.obj,c=c.props,e;for(e in c)d.off("change:"+e,null,this)}},r:function(){for(var a=0;a<this.h.length;a++)this.h[a].destroy();this.h=[]},destroy:function(){this.k=
!0;this.D();this.r()}});var ha=1,U=[],T,W={},C,B=0,V,M=this.$&&$.fn&&$.fn.scrollTop,la=M&&$(window),Z;M&&($.fn.scrollTop=function(a){a&&(Z=!0);return M.apply(this,arguments)});var ua=/[.]+/,q={n:!0,make:function(a){function b(a,d,e){return"function"===typeof a?s(a,d):"function"!==typeof d||A(d)?0===arguments.length?b.query():1===arguments.length?b.query(a):2===arguments.length?b.query(a,d):b.query(a,d,e):b.query(a,ea.extend({state:d}).make())}e.extend(b,this,"function"===typeof a?{state:a}:a||{});
delete b.tboneid;delete b.attributes;b._events={};b.g={};y(b);b.initialize();return b},extend:function(a){return e.extend({},this,a)},initialize:n,on:function(a,b,c){b=ba(a);a=this._events;for(var d;null!=(d=b.shift());)""!==d&&(a[d]||(a[d]={}),a=a[d]);(b=a[""])||(b=a[""]={});a=y(c);b[a]=c;this.c({})},off:function(a,b,c){a=ba(a);b=this._events;for(var d;null!=(d=a.shift());)""!==d&&(b[d]||(b[d]={}),b=b[d]);if(a=b[""])c=y(c),delete a[c]},trigger:function(a){var b=this._events;a=ba(a);for(var c;null!=
(c=a.shift());)""!==c&&(b[c]||(b[c]={}),b=b[c]);var b=b[""]||{},d;for(d in b)b[d].trigger.call(b[d])},runOnlyOnce:function(a){var b;s(function(){b||a()});b=!0},query:N,queryModel:function(a){return this.query(1,a)},readSilent:function(a){var b=u;u=null;a=this.query(a);u=b;return a},idAttribute:"id",queryId:function(){return this.query(this.idAttribute)},toggle:function(a){this.query(7,a)},push:function(a,b){1===arguments.length&&(b=a,a="");this.query(3,a,b)},unshift:function(a,b){1===arguments.length&&
(b=a,a="");this.query(4,a,b)},removeFirst:function(a){this.query(5,a)},removeLast:function(a){this.query(6,a)},unset:function(a){this.query(8,a)},increment:function(a,b){this.query(9,a,null!=b?b:1)},clear:function(){this.query("",void 0)},toJSON:function(){return this.attributes},c:n,queryText:K,text:K,lookup:N,lookupText:K,set:N,get:N},ea=q.extend({initialize:function(){this.scope=s(this.update,this.B,this,this.Name&&"model_"+this.Name,this.f,this,!0)},B:3E3,c:function(a){this.a&&(this.a=!1,this.reset());
e.each(this.scope&&this.scope.o||[],function(b){(b=b.obj)&&!a[y(b)]&&(a[y(b)]=!0,b.c(a))})},f:function(){},update:function(){(this.a=this.sleepEnabled&&!fa(this))||this.q()},q:function(){this.query("",this.state())},reset:function(){this.scope&&this.scope.trigger()},destroy:function(){this.scope&&this.scope.destroy();this.unset("")},state:n,sleepEnabled:!1}),R=ea.extend({q:function(){var a=this,b=a.J=(a.J||0)+1,c=a.state(function(c){if(b>=(a.L||0))return a.L=b,a.j=null,a.query("",c),!0});a.j=c&&c.onAbort},
abortPrevious:function(){this.j&&this.j()},B:1E3}),Ha=1,oa=q.extend({e:!0,n:!0,model:q,add:function(a){function b(){d.increment("size",-1);g=!0;c()}function c(){null!=f&&(d.unset(f,null),d.trigger("change:"+f),delete d.g[f]);if(!g){var a=e.queryId();null==a&&(a="__unidentified"+Ha++);a="#"+a;d.query(a,e);d.trigger("change:"+a);d.g[a]=b;f=a}}var d=this,e,f;A(a)?e=a:(e=d.model.make(),e.query("",a));var g;d.increment("size");s(c)},remove:function(a){a="#"+(A(a)?a.queryId():a);if(this.g[a])this.g[a]()}}),
wa={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"},Ia=R.extend({state:function(a){function b(){d&&(B--,d=null,c.onComplete())}var c=this,d,e=c.url();null!=e&&e!==c.l&&(c.l=e,c.abortPrevious(),c.clearOnFetch&&c.clear(),va(c,{dataType:"text",success:function(b){a(c.parse(b))&&(c.postFetch(),c.trigger("fetch"))},complete:b,beforeSend:function(a){B++;d=a;a.__tbone__=!0},url:e}));return{Q:function(){d&&(d.abort(),b())}}},parse:function(a){return a},ajax:function(){return $.ajax.apply($,
arguments)},postFetch:n,onComplete:n,clearOnFetch:!0,sleepEnabled:!0}),Ja=q.extend({initialize:function(){var a=this;a.query("",JSON.parse(localStorage[a.key]||"null"));s(function(){localStorage[a.key]=JSON.stringify(a.R(""))})}}),Ka=q.extend({initialize:function(){var a=this;$(window).bind("hashchange",function(){a("hash",location.hash)});a("hash",location.hash);a(function(){var b=a("hash");location.hash!==b&&(location.hash=b)})}}),La=oa.extend({initialize:function(){var a=this,b=JSON.parse(localStorage[a.key]||
"null");e.each(b||[],function(b){a.add(b)});s(function(){localStorage[a.key]=JSON.stringify(a.query())})}}),Aa=/<%(=|-|@|)([\s\S]+?)%>/g,Ca=RegExp("function \\( ([\\w$_]* (, [\\w$_]+)*)  \\)|(\\{)|(\\})|([\\s\\S])".replace(/ /g,"[\\s\\n]*"),"g"),Da=/[\w$_]+/g,Ba=/([^'"]+)('[^']+'|"[^"]+")?/g,ya=RegExp("(\\. )?(([\\w$_]+)(\\.[\\w$_]+)*)".replace(/ /g,"[\\s\\n]*"),"g"),aa=/^\d+$/,ca={};e.each("break case catch continue debugger default delete do else finally for function if in instanceof new return switch this throw try typeof var void while with Array Boolean Date Function Iterator Number Object RegExp String isFinite isNaN parseFloat parseInt Infinity JSON Math NaN undefined true false null $ _ tbone T view window".split(" "),
function(a){ca[a]=!0});var Q={},pa=0,qa={make:function(a){var b={};e.extend(b,this);b.initialize(a);return b},extend:function(a){return e.extend({},this,a,{v:this})},$:function(a){return this.$el.find(a)},H:!0,initialize:function(a){y(this);e.extend(this,a);this.$el=$(this.el);this.el.view=this;this.b=this.d?this.d.b-1:2E3;this.scope=s(this.render,this.b,this,"view_"+this.Name,this.f,this,!0)},f:function(){},destroy:function(){var a=this;a.k=!0;a.scope.destroy();e.each(a.p||[],function(b){b.destroy(a)});
a.destroyDOM(a.$el)},render:function(){var a=this;if(!a.k){pa++;if(a.C){var b=document.activeElement,c,d,h,f;if(e.contains($(b).parents(),a.el)){c="input";d=e.indexOf(a.$(c),b);var g=b.getAttribute("type");"submit"!==g&&"button"!==g&&(h=b.selectionStart,f=b.selectionEnd)}b=$("<div>").append(this.$el.children());g=Ea(a.C,a);a.$el.html(g);a.ready();a.postReady();g=a.p||[];a.p=na(a.$("[tbone]"),a,g);g=e.difference(g,a.p);e.each(g,function(b){b.destroy(a)});a.destroyDOM(b);c&&(c=a.$(c)[d])&&($(c).focus(),
null!=h&&null!=f&&(c.selectionStart=h,c.selectionEnd=f))}else a.ready(),a.postReady();a.postRender();Ga++;pa--}},ready:n,postReady:n,postRender:n,destroyDOM:function(){},root:function(){return this.query(1)},query:function(a,b,c){var d=!1;"number"!==typeof a&&(c=b,b=a,a=0,d=2===arguments.length);b=(this.A?this.A+".":"")+(b||"");return d?this.w(a,b,c):this.w(a,b)},parentRoot:function(){return this.d&&this.d.root()},parent:function(){return this.d},getHashId:function(a){if(!A(a)){var b=g.make();b.query("",
a);a=b}if(!a.m){for(var b=[],c=20;c;c--)b.push("0123456789ABCDEF".charAt(Math.floor(16*Math.random())));a.m=b.join("")}Q[a.m]=a;return a.m},isQueryable:A,denullText:S},da=qa,Fa=/[^\w.]*([\w.]+)[^\w.]+([\w.]+)/g,g=q.make({Name:"tbone"}),Ma=r.tbone,Na=r.T;r.tbone=g;r.T=g;g.models=z;g.views=P;g.collections=G;g.templates=L;g.createView=function(a,b,c,d){var h=[].slice.call(arguments),f=h.shift();"string"===typeof f?(a=f,f=h.shift()):a="v"+ha++;f&&f.extend?(b=f,f=h.shift()):b=da;"function"===typeof f?
(c=f,f=h.shift()):c=null;d=e.extend({},f||{},{Name:a});var g=b.ready;c&&(d.ready=g===n?c:function(){g.call(this);c.call(this)});return P[a]=b.extend(d)};g.setDefaultView=function(a){da=a};g.addTemplate=function(a,b){L[a]=b};g.dontPatch=function(a){ca[a]=!0};g.render=na;g.denullText=S;g.priority={highest:1E4,bound:3E3,beforeViews:2500,view:2E3,afterViews:1500,async:1E3,lowest:0};g.drain=function(){C&&clearTimeout(C);X()};g.isReady=ia;g.noConflict=function(){r.T=Na;r.tbone=Ma};z.base=q;z.bound=ea;z.async=
R;z.ajax=Ia;z.localStorage=Ja;z.location=Ka;G.base=oa;G.localStorage=La;P.base=qa;try{dispatchEvent(new CustomEvent("tbone_loaded"))}catch(Oa){}if(q=r.Backbone){var ra=function(a,b,c){var d=1===a,h=2===a,f=7===a,g=3===arguments.length,l=f||g;"number"!==typeof a&&(c=b,b=a,a=0,2===arguments.length&&(g=l=!0));b=(b||"").replace(/\.?(__self__)?\.?$/,"");var k=b.split("."),q;l&&(q=k[k.length-1]);for(var n,p=d&&!b?this:this.e?this.models:this.attributes,r=[],s=k[0]||"",t=b?p[s]:p,v,w;null!=(v=k.shift());)if(""!==
v)if(r.push(v),n=p,p=p[v],null==p)if(l)p=aa.exec(k[0])?[]:{},n[v]=p;else break;else if(A(p)){w=!0;break}!l&&u&&(r=y(this),u[r]||(u[r]={obj:this,props:{}}),u[r].props[s]=t);if(w&&(!d||k.length))return g?p.query(a,k.join("."),c):p.query(a,k.join("."));if(l){if(null==n)if(this.e)this.reset(null!=c?c:[]);else if(c){for(var x in this.toJSON())void 0===c[x]&&this.unset(x);this.set(c)}else this.clear();else f?c=n[q]=!p:n[q]!==c&&(n[q]=c),s&&this.trigger("change:"+s),this.trigger("change");return c}p&&!h&&
this.e&&""===b&&(p=e.map(p,function(a){return a.query()}));return p},R=q.Model.extend({n:!0,initialize:function(){var a=this;y(a);var b=(a.a=a.s())?1E3:3E3;ka({execute:function(){a.scope=s(a.update,b,a,"model_"+a.Name,a.f,a)},b:b+5E3})},s:function(){return!!this._url},f:function(){},reset:function(){this.scope&&this.scope.trigger()},isVisible:function(){return fa(this)},update:function(){this.s()?this.K():this.M()},K:function(){function a(){c===b.i&&(B--,delete b.i)}var b=this,c,d=b.url(),e=b.l;b.a=
!this.isVisible();b.a?b.a=!0:null!=d&&d!==e&&(b.l=d,b.clearOnFetch&&b.clear(),b.fetch({dataType:"text",success:function(){b.postFetch();b.trigger("fetch");b.toJSON()},complete:a,beforeSend:function(d){b.i&&(b.i.abort(),a());B++;c=b.i=d;d.__tbone__=!0},url:d}))},M:function(){this.state&&(this.query("",this.state()),this.toJSON())},state:null,postFetch:n,clearOnFetch:!0});e.each([q.Model.prototype,q.Collection.prototype],function(a){e.extend(a,{isBackbone:!0,query:ra,text:K,lookup:ra,lookupText:K,c:function(a){this.a&&
(this.trigger("wake"),this.a=!1,this.reset());e.each(this.scope&&this.scope.o||[],function(b){(b=b.obj)&&!a[y(b)]&&(a[y(b)]=!0,b.c(a))})}});var b=a.on;a.on=function(){this.c({});return b.apply(this,arguments)}});z=z.bbbase=R;G=G.bbbase=q.Collection.extend({e:!0});e.each([z,G],function(a){e.extend(a.prototype,{_validate:function(){return!0}})})}})();
